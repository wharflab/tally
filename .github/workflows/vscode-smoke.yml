---
name: VS Code Smoke
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
permissions:
  contents: read
  id-token: write
env:
  GOEXPERIMENT: jsonv2
jobs:
  vscode-smoke:
    name: VS Code Smoke (Linux)
    runs-on: ubuntu-latest
    env:
      GOCOVERDIR: ${{ github.workspace }}/coverage-vscode-smoke
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
      - name: Resolve VS Code version
        id: vscode
        run: |
          set -euo pipefail
          VERSION=$(curl -fsSL "https://update.code.visualstudio.com/api/releases/stable?released=true" | python3 -c 'import json,sys; print(json.load(sys.stdin)[0])')
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Cache VS Code test install
        uses: actions/cache@v5
        with:
          path: extensions/vscode-tally/.vscode-test
          key: vscode-test-${{ runner.os }}-${{ steps.vscode.outputs.version }}
          restore-keys: |
            vscode-test-${{ runner.os }}-
      - name: Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb
      - name: Prepare coverage dir
        run: mkdir -p "$GOCOVERDIR"
      - name: Install extension dependencies
        working-directory: extensions/vscode-tally
        run: bun install --frozen-lockfile
      - name: Run smoke test
        working-directory: extensions/vscode-tally
        env:
          VSCODE_TEST_VERSION: ${{ steps.vscode.outputs.version }}
          VSCODE_TEST_DOWNLOAD_TIMEOUT_MS: "120000"
        run: xvfb-run -a bun run test:e2e
      - name: Convert coverage
        run: |
          go tool covdata textfmt -i="$GOCOVERDIR" -o=coverage-vscode-smoke.txt
          # Drop generated code from coverage to avoid skewing project totals.
          bash scripts/filter-go-coverprofile.sh coverage-vscode-smoke.txt coverage-vscode-smoke.filtered.txt
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          use_oidc: true
          files: coverage-vscode-smoke.filtered.txt
          fail_ci_if_error: true
