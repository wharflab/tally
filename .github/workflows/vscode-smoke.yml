---
name: VS Code Smoke
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:
permissions:
  contents: read
  id-token: write
env:
  GOEXPERIMENT: jsonv2
jobs:
  vscode-smoke:
    name: VS Code Smoke (Linux)
    runs-on: ubuntu-latest
    env:
      GOCOVERDIR: ${{ github.workspace }}/coverage-vscode-smoke
    steps:
      - uses: actions/checkout@v6
      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: "1.3.9"
      - name: Install Xvfb
        run: sudo apt-get update && sudo apt-get install -y xvfb
      - name: Prepare coverage dir
        run: mkdir -p "$GOCOVERDIR"
      - name: Install extension dependencies
        working-directory: extensions/vscode-tally
        run: bun install --frozen-lockfile
      - name: Run smoke test
        working-directory: extensions/vscode-tally
        run: xvfb-run -a bun run test:e2e
      - name: Convert coverage
        run: go tool covdata textfmt -i="$GOCOVERDIR" -o=coverage-vscode-smoke.txt
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          use_oidc: true
          files: coverage-vscode-smoke.txt
          fail_ci_if_error: true
